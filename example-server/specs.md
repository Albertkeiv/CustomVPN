# Простой тестовый Control-сервер (example-server)

Этот документ описывает минимальный тестовый сервер управления (Control-сервер) для локальной разработки и тестирования клиента CustomVPN.

Сервер реализуется на Go (Golang) версии 1.25.5 под Windows (может работать и на других платформах, но целевой сценарий — локальный dev под Windows).

## Цели

- Предоставить предсказуемую реализацию API, описанного в specs/data-models-specs.md (эндпоинты `/health`, `/auth`, `/sync/servers`, `/sync/routes`).
- Обеспечить простую конфигурацию тестовых пользователей, серверов и профилей маршрутизации.
- Не решать задачи безопасности/масштабирования — это исключительно dev/integration-сервер.

---

## 1. Общие требования

- Язык: Go (Golang) версии 1.25.5.
- Режим работы: одиночный HTTP-сервер, по умолчанию слушает `127.0.0.1:8080`.
- Формат данных: JSON (UTF-8).
- Логирование: в stdout (для простоты), с временем и уровнем (`info`/`error`).
- Хранение данных: в памяти при запуске, опционально загрузка из простого конфигурационного файла (YAML/JSON) — можно добавить позже.

---

## 2. Модель данных сервера (MVP)

### 2.1. Пользователь (User)

Минимальная модель пользователя:

- `Login: string` — логин (строка).
- `Password: string` — пароль (в тестовом сервере хранится в явном виде).
- `ID: string` — внутренний идентификатор (по желанию).

В MVP допускается один жёстко зашитый пользователь (например, `test` / `test`).

### 2.2. Токен (AuthToken)

Для простоты в MVP:

- Токен — непрозрачная строка (например, UUID или случайный hex), без криптографии.
- Структура в памяти:
  - `Value: string`
  - `UserLogin: string`
  - `IssuedAt: time`
  - `ExpiresAt: time | null` (в MVP можно считать токен "долгоживущим" без фактической проверки истечения).

Сервер хранит активные токены в карте `map[string]AuthToken` (ключ — `Value`).

### 2.3. Серверы (ServerDTO)

Структура соответствует описанию в specs/data-models-specs.md.

Поля:

- `id: string`
- `name: string`
- `country: string`
- `host: string`
- `port: number`
- `core_config: object`

На стороне example-server эти данные могут быть:

- либо жёстко зашиты в коде;
- либо загружены из файла конфигурации (опционально, для расширения).

### 2.4. Профили маршрутизации (RouteProfileDTO)

Структура:

- `id: string`
- `name: string`
- `direct_routes: string[]` — IPv4 CIDR-строки.
- `tunnel_routes: string[]` — IPv4 CIDR-строки.

Аналогично, могут быть жёстко зашиты или загружены из файла.

---

## 3. Эндпоинты HTTP API

### 3.1. GET /health

Проверка «живости» сервера.

- Метод: `GET`
- Путь: `/health`
- Запрос: без тела.
- Ответ при успехе:
  - Код: `200 OK`
  - Заголовки: `Content-Type: application/json; charset=utf-8`
  - Тело: строка JSON `"OK"` (не объект).

Примеры:

- Успех:
  - Ответ: `200` + тело `"OK"`.

Любой другой ответ (код != 200 или тело != `"OK"`) должен трактоваться клиентом как ошибка Preflight.

### 3.2. POST /auth

Авторизация пользователя по логину/паролю.

- Метод: `POST`
- Путь: `/auth`
- Заголовки:
  - `Content-Type: application/json`
- Тело запроса (JSON):

```json
{
  "login": "test",
  "password": "test"
}
```

- Обработка:
  - Сервер сверяет `login`/`password` с известной парой (или таблицей пользователей).

- Успешный ответ:
  - Код: `200 OK`
  - Тело:

```json
{
  "authToken": "<opaque-token>"
}
```

  - Токен генерируется сервером и сохраняется в внутреннем хранилище токенов.

- Неуспешный ответ (неверные логин/пароль):
  - Код: `401 Unauthorized`
  - Тело: строка JSON `"Auth Failed"`.

### 3.3. Авторизация по токену

Для эндпоинтов `/sync/servers` и `/sync/routes` требуется действующий токен.

Рекомендуемый способ передачи токена в MVP:

- Заголовок: `Authorization: Bearer <authToken>`

При отсутствии или невалидном токене:

- Код: `401 Unauthorized`
- Тело: строка JSON `"Auth Failed"` или объект с полем ошибки (на усмотрение, клиенту достаточно кода и факта ошибки для Error(AuthFailed)).

### 3.4. GET /sync/servers

Возвращает список доступных серверов и их Core-конфигурации.

- Метод: `GET`
- Путь: `/sync/servers`
- Требуется заголовок `Authorization: Bearer <authToken>`.

- Успешный ответ:
  - Код: `200 OK`
  - Тело: JSON-массив `ServerDTO[]`.

Пример:

```json
[
  {
    "id": "server-1",
    "name": "Frankfurt #1",
    "country": "DE",
    "host": "fr1.example.com",
    "port": 443,
    "core_config": {
      "inbounds": [ /* ... */ ],
      "outbounds": [ /* ... */ ]
    }
  }
]
```

Ошибки:

- 401 — при отсутствии/невалидном токене.
- 500 — при внутренних ошибках (невалидные данные, ошибки загрузки конфигурации и т.п.).

### 3.5. GET /sync/routes

Возвращает список профилей маршрутизации.

- Метод: `GET`
- Путь: `/sync/routes`
- Требуется заголовок `Authorization: Bearer <authToken>`.

- Успешный ответ:
  - Код: `200 OK`
  - Тело: JSON-массив `RouteProfileDTO[]`.

Пример:

```json
[
  {
    "id": "default",
    "name": "Default",
    "direct_routes": [
      "10.0.0.0/8",
      "192.168.0.0/16"
    ],
    "tunnel_routes": [
      "0.0.0.0/0"
    ]
  }
]
```

Ошибки:

- 401 — при отсутствии/невалидном токене.
- 500 — при внутренних ошибках.

---

## 4. Логирование example-server

Минимальные требования:

- Все запросы логируются на уровне `info`:
  - метод, путь, код ответа, время обработки.
- Ошибки (401, 500) логируются на уровне `error` с указанием причины.
- Формат строки лога (пример):

```text
[2025-12-22T15:04:05Z] INFO  GET /sync/servers 200 3.5ms
[2025-12-22T15:04:07Z] ERROR POST /auth 401 invalid credentials
```

---

## 5. Конфигурация example-server

Для удобства тестирования сервер может использовать простой конфигурационный файл (например, `server-config.yaml` или `server-config.json`).

### 5.1. Параметры конфигурации (MVP)

Минимальный набор параметров:

- адрес и порт прослушивания (по умолчанию `127.0.0.1:8080`);
- логин и пароль тестового пользователя;
- путь к папке с конфигурациями серверов (Core-конфиги);
- путь к папке с профилями маршрутов.

В терминах структуры:

- `listen_addr: string` — адрес и порт, например `"127.0.0.1:8080"`;
- `user_login: string` — логин тестового пользователя;
- `user_password: string` — пароль тестового пользователя;
- `servers_dir: string` — путь к каталогу, где лежат файлы с описаниями серверов/Core-конфигами;
- `routes_dir: string` — путь к каталогу, где лежат файлы с профилями маршрутизации.

Если конфигурация не задана, сервер может использовать жёстко зашитые значения по умолчанию (один пользователь `test` / `test`, один сервер, один профиль маршрутов).

### 5.2. Формат файлов в папках конфигураций

Конкретный формат файлов в папках `servers_dir` и `routes_dir` может быть выбран на этапе реализации (JSON или YAML), при этом содержимое по смыслу должно соответствовать структурам `ServerDTO` и `RouteProfileDTO`.
