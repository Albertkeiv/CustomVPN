# Чек-лист задач для основного клиента CustomVPN

Этот план опирается на спецификации:
- specs/init-specs.md
- specs/state-specs.md
- specs/data-models-specs.md

ID задач начинаются с `C-XX` (Client).

---

## Этап 1. Базовая структура проекта и зависимости

- [x] [C-01] Инициализировать Go-модуль (go.mod) под Go 1.25.5 для десктопного приложения.
- [x] [C-02] Подключить зависимости:
  - Fyne (GUI и трей);
  - HTTP-клиент (стандартная библиотека);
  - YAML-парсер для `config.yaml`;
  - `golang.org/x/sys/windows` для работы с маршрутами/интерфейсами (подготовка к маршрутизации).
- [x] [C-03] Создать каркас папок: `cmd/app`, `internal/config`, `internal/logging`, `internal/state`, `internal/controlclient`, `internal/routes`, `internal/process`, `internal/ui`.

---

## Этап 2. Конфигурация и логирование

- [x] [C-05] Реализовать загрузку `config.yaml` из каталога приложения, с ошибкой ConfigFailed при отсутствии/битости.
- [x] [C-06] Добавить возможность указания альтернативного пути к конфигу (флаг/аргумент командной строки).
- [x] [C-07] Реализовать модуль логирования:
  - уровни `debug`/`info`/`error`;
  - запись во внешний файл (`log_file`) с таймштампом;
  - отдельные лог-файлы для Core и Tun.
- [x] [C-08] Протянуть логгер во все внутренние пакеты (через контекст/инъекцию).

---

## Этап 3. Модели данных и клиент Control-сервера

- [x] [C-09] Реализовать структуры DTO для API:
  - `ServerDTO` и `RouteProfileDTO` как в specs/data-models-specs.md;
  - структуры для `/auth` и `/health` (если нужны вспомогательные типы).
- [x] [C-10] Реализовать внутренние модели `Server`, `RouteProfile`, `GatewayInfo`, `RouteRecord`, `RoutesRegistry`, `ProcessRecord`, `ProcessRegistry`, `ErrorInfo`, `UIState`, `AppContext` по specs/data-models-specs.md и specs/state-specs.md.
- [x] [C-11] Реализовать HTTP-клиент Control-сервера:
  - `CheckHealth()` → `/health` (200 + "OK" или ошибка);
  - `Auth(login, password)` → `/auth` (возврат authToken или AuthFailed);
  - `SyncServers(authToken)` → `/sync/servers` (возврат `[]Server`);
  - `SyncRoutes(authToken)` → `/sync/routes` (возврат `[]RouteProfile`).
- [x] [C-12] Обработать коды ошибок и маппинг на ErrorKind: NetworkUnavailable, AuthFailed, SyncFailed, Unknown.

---

## Этап 4. State machine и очередь событий

- [x] [C-13] Реализовать перечисления состояний (`State`) и событий (`Event`) согласно specs/state-specs.md.
- [x] [C-14] Реализовать структуру `AppContext` (Config, AuthToken, ServersList, RoutesProfiles, DefaultGateway, Registries, UI и т.п.).
- [x] [C-15] Реализовать главный event-loop в виде одного goroutine с каналом событий (см. 10.9 в state-specs.md).
- [x] [C-16] Реализовать функцию `HandleEvent(ctx *AppContext, event Event)` согласно псевдокоду из раздела 8 state-specs.md.
- [x] [C-17] Добавить обработку системных событий: SYS_РезультатPreflight, SYS_РезультатAuth, SYS_РезультатSync, SYS_РезультатPrepareEnv, SYS_ПроцессЗавершён, SYS_Таймаут.
- [x] [C-18] Реализовать механизм приоритета события выхода (TRAY_Выход / UI_ВыходИзМеню) поверх очереди событий.

---

## Этап 5. Preflight, Auth, Sync (бэкграунд-операции)

- [x] [C-19] Реализовать процедуру `Preflight()`:
  - 3 попытки `/health` с интервалом 2 секунды;
  - генерация SYS_РезультатPreflight(успех|ошибка) для state machine.
- [x] [C-20] Реализовать процедуру авторизации `Авторизация(логин, пароль)`:
  - вызов `/auth`;
  - сохранение authToken в `AppContext`;
  - генерация SYS_РезультатAuth(успех|ошибка).
- [x] [C-21] Реализовать процедуру `СинхронизацияСписков()`:
  - последовательные вызовы `/sync/servers` и `/sync/routes`;
  - валидация данных; целиковый провал при любой ошибке;
  - генерация SYS_РезультатSync(успех|ошибка).

---

## Этап 6. PreparingEnvironment и маршрутизация на Windows

- [x] [C-22] Реализовать функцию определения default gateway (`GatewayInfo`) на Windows (0.0.0.0/0, InterfaceIndex, Metric).
- [x] [C-23] Реализовать модуль работы с маршрутами:
  - добавление host-маршрутов до Control-сервера (Service);
  - добавление/удаление Direct/Tunnel маршрутов с нужной метрикой и привязкой к InterfaceIndex;
  - регистрацию/удаление маршрутов в `RoutesRegistry`.
- [x] [C-24] Реализовать процедуру `ПодготовкаОкружения()`:
  - поиск единственного маршрута по умолчанию (иначе RoutingFailed);
  - добавление служебного маршрута до Control-сервера;
  - генерация SYS_РезультатPrepareEnv(успех|ошибка).

---

## Этап 7. Управление процессами Core и Tun

- [x] [C-25] Реализовать модуль запуска процессов:
  - запуск Core по пути `core_path` с конфигом `<app_dir>/core_config/<server-name>.json`;
  - запись stdout/stderr Core и Tun в отдельные лог-файлы.
- [x] [C-26] Реализовать `ProcessRegistry` и обновление статусов (Starting, Running, Exited, Failed).
- [x] [C-27] Добавить обработку события SYS_ПроцессЗавершён(Core|Tun) и маппинг на Error(ProcessFailed) + запуск Disconnecting.

---

## Этап 8. Сценарии Connecting и Disconnecting

- [x] [C-28] Реализовать процедуру `СценарийПодключения()` согласно 10.4 state-specs.md:
  - добавление маршрута до прокси и DirectRoutes;
  - генерация/дамп Core-конфига из `Server.CoreConfigRaw` в `<app_dir>/core_config/<server-name>.json`;
  - запуск Core и Tun с таймаутами;
  - проверка доступности (минимум: проверка inbound-порта Tun/Core);
  - rollback при любой ошибке, как описано в спецификации.
- [x] [C-29] Реализовать процедуру `СценарийОтключения()` согласно 10.5:
  - остановка Tun, затем Core (мягко, потом принудительно через 5 секунд);
  - удаление маршрутов туннеля (DirectRoutes, маршрут до прокси);
  - сохранение служебных маршрутов до Control.

---

## Этап 9. GUI на Fyne (окно логина и главное окно)

- [x] [C-30] Реализовать окно логина:
  - поля логин/пароль, кнопка «Войти»;
  - привязка к событиям UI_НажатаВойти и UI_ВводЛогинаПароля;
  - отображение ошибок AuthFailed.
- [x] [C-31] Реализовать главное окно:
  - список серверов (название + страна);
  - список профилей маршрутизации;
  - кнопки «Подключиться», «Отключиться», «Настройки», «Выход»;
  - индикатор состояния (подключено/отключено) и текст статуса.
- [x] [C-32] Связать UI с state machine:
  - диспатчинг событий в главный event-loop;
  - обновление UIState (доступность кнопок, выбранные элементы) по текущему состоянию.

---

## Этап 10. Системный трей и поведение окна

- [ ] [C-33] Настроить иконку в системном трее Fyne.
- [ ] [C-34] Реализовать меню трея: «Показать/Скрыть окно», «Подключиться», «Отключиться», «Выход».
- [ ] [C-35] Обеспечить поведение «X» — только скрытие окна, не выход.
- [ ] [C-36] Реализовать приоритет команды "Выход" над другими командами (в т.ч. во время Connecting/Disconnecting).

---

## Этап 11. Обработка ошибок и UX ошибок

- [ ] [C-37] Реализовать отображение модальных окон ошибок в соответствии с ErrorKind (см. 10.6 state-specs.md).
- [ ] [C-38] Обеспечить маппинг ErrorInfo.UserMessage на текст в диалогах.
- [ ] [C-39] Логировать `ErrorInfo.TechnicalMessage` через модуль логирования.

---

## Этап 12. Отслеживание смены сети (расширение, можно отложить)

- [ ] [C-40] Реализовать мониторинг сети на Windows (NotifyIpInterfaceChange / NotifyRouteChange2 или fallback-опрос) согласно разделу 11 state-specs.md.
- [ ] [C-41] Реализовать дедупликацию событий и генерацию SYS_СетьИзменилась(newGateway).
- [ ] [C-42] Реализовать реакцию на смену сети по состояниям (ReadyDisconnected, Connected и др.), как описано в 11.3 и 11.6.

---

## Этап 13. Тестирование и полировка

- [ ] [C-43] Интегрировать приложение с example-server (локальный запуск, успешный Preflight/Auth/Sync).
- [ ] [C-44] Протестировать полный happy-path: запуск → логин → выбор сервера/профиля → подключение → проверка маршрутов и процессов → отключение → выход.
- [ ] [C-45] Протестировать основные ошибки: недоступен Control, неверный логин/пароль, битые Sync-данные, падение Core/Tun, неединственный default gateway.
- [ ] [C-46] Задокументировать процесс сборки и запуска (README, краткая инструкция по конфигу и example-server).
