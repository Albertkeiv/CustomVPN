## Описание проекта

Проект представляет собой десктопное GUI-приложение под Windows, предназначенное для управления прокси-подключением и туннелированием сетевого трафика. Приложение является оболочкой над консольными утилитами и не реализует собственный сетевой стек.

Основная задача приложения — предоставить пользователю простой и понятный интерфейс для авторизации, выбора прокси-сервера, выбора схемы маршрутизации, запуска и остановки туннеля, а также автоматического управления системными маршрутами.

Приложение ориентировано на постоянную работу в фоне и управление через системный трей.

---

## Целевая платформа

На первом этапе:

* Операционная система: Windows
* Архитектура: x64
* Режим работы: desktop-приложение с системным треем

macOS и другие платформы рассматриваются в будущем. Архитектура закладывается кроссплатформенной, однако реализация начинается строго с Windows.

---

## Используемый язык и технологии

### Язык

* Go (Golang) версии 1.25.5 (целевой рантайм: Windows x64)

### GUI

* Fyne

Причины выбора:

* нативный Go-GUI без web-стека;
* встроенная поддержка системного трея;
* единый API для окон, меню и иконок;
* предсказуемый жизненный цикл приложения.

### Внешние утилиты

Приложение использует внешние консольные утилиты, запускаемые как отдельные процессы:

* xray **или** sing-box (окончательный выбор будет сделан позже);

Взаимодействие осуществляется через:

* запуск и завершение процессов;
* передачу параметров запуска;
* генерацию и применение конфигурационных файлов;
* контроль состояния процессов.

По умолчанию бинарники внешних утилит поставляются вместе с приложением и располагаются в каталоге приложения:

* `<app_dir>/<core-name>` — Core (xray или sing-box);

Фактические пути задаются в конфигурационном файле приложения и могут быть переопределены пользователем.

---

## Архитектурная концепция

Приложение выполняет роль оркестратора и управляющей оболочки:

* управляет конфигурациями;
* запускает и останавливает сетевые утилиты;
* добавляет и удаляет маршруты в системе;
* контролирует состояние подключения;
* отображает статус пользователю.

GUI и логика управления процессами находятся в одном бинарном файле.

Приложение предполагает запуск с повышенными правами (Administrator), так как выполняет операции с маршрутами и сетевыми настройками.

---

## Конфигурация приложения

Приложение использует конфигурационный файл в формате YAML.

Минимальный состав параметров конфигурации в MVP:

* `control_server_url` — URL Control-сервера;
* `core_path` — путь к бинарнику Core (по умолчанию — внутри каталога приложения, см. выше);
* `log_level` — уровень логирования (`info` | `debug` | `error`);
* `log_file` — путь к основному лог-файлу приложения.

Конфигурация читается на старте приложения в состоянии AppStarting.
Файл конфигурации `config.yaml` расположен в каталоге приложения (рядом с исполняемым файлом). Отсутствие файла или ошибки разбора YAML приводят к ошибке ConfigFailed и отображению соответствующей ошибки пользователю.

Приложение также ведёт отдельные лог-файлы для внешних процессов:

* один лог для GUI/оркестратора (путь задаётся через `log_file`);
* отдельный лог для Core;

Уровни логирования:

* `debug` — максимально подробные сообщения (запуски процессов, параметры команд, детальная информация о маршрутах, ответы Control-сервера и т.п.);
* `info` — ключевые операции (запуск/остановка, запросы к Control-серверу, добавление/удаление маршрутов, успешные и неуспешные подключения);
* `error` — только ошибки.

Каждая запись в логе должна содержать отметку времени и текст сообщения.

---

## Окна приложения

### Окно логина

Назначение:

* авторизация пользователя перед доступом к основному функционалу.

Содержимое:

* поле логина;
* поле пароля;
* кнопка «Войти».

Поведение:

* при запуске приложения выполняется проверка доступности серверов;
* пользователь вводит логин и пароль;
* выполняется запрос к серверу авторизации;
* при успешной авторизации происходит инициализация данных и переход в главное окно.

---

### Главное окно

Назначение:

* основное управление подключением.

Содержимое:

* список доступных прокси-серверов (полученных с сервера);
* выбор варианта маршрутизации;
* кнопка «Подключиться»;
* кнопка «Отключиться»;
* кнопка «Настройки»;
* кнопка «Выход».

Дополнительно:

* в списке серверов отображаются название сервера и страна;
* иконки стран для серверов (по возможности);
* простые статусные значки;
* индикатор состояния (подключено / отключено).

Поведение:

* окно может быть скрыто в системный трей;
* закрытие окна не завершает приложение, а прячет его.

---

### Окно настроек

Назначение:

* конфигурация параметров приложения.

На первом этапе:

* минимальный набор настроек;
* экран закладывается как расширяемый.

---

## Системный трей

Приложение постоянно работает в системном трее.

Функции трея:

* показать / скрыть главное окно;
* подключиться;
* отключиться;
* выход из приложения (единственный способ полного завершения).

Трей является основным способом управления приложением после первого запуска.

---

## Логика запуска приложения

При старте приложение выполняет следующую последовательность действий:

1. Запуск приложения.
2. Проверка доступности серверов, указанных в конфигурации.
3. Отображение окна логина.
4. Авторизация пользователя (логин/пароль, запрос на сервер).
5. Проверка и обновление списков:

   * прокси-серверов;
   * маршрутов.
6. Определение основного сетевого шлюза из сетевых настроек Windows.
7. Добавление маршрутов:
    * до обслуживающего (Control) сервера
       через шлюз по умолчанию (служебный маршрут).
8. Ожидание выбора сервера и схемы маршрутизации пользователем.

---

## Логика подключения

При нажатии кнопки «Подключиться»:

1. Назначается прямой маршрут до выбранного прокси-сервера через текущий шлюз по умолчанию.
2. Назначаются маршруты для сетей, которые должны идти напрямую (DirectRoutes из выбранного профиля маршрутизации).
3. Генерируется и применяется конфигурация для xray / sing-box (Core) и запускается процесс Core в каталоге приложения.
5. Выполняется быстрая проверка доступности (например, запрос к внешнему сервису для проверки текущего IP через туннель).
6. При успехе приложение переходит в состояние «Подключено».

---

## Логика отключения

При нажатии кнопки «Отключиться»:

2. Завершается процесс xray / sing-box.
3. Удаляются маршруты, связанные с туннелем и профилем маршрутизации (включая прямой маршрут до прокси и DirectRoutes), при этом служебный маршрут до Control-сервера, добавленный на этапе запуска, сохраняется до полного выхода из приложения.
4. Приложение возвращается в состояние «Отключено» (ReadyDisconnected).

---

## Основная пользовательская история

1. Пользователь запускает приложение.
2. Проходит авторизацию.
3. Выбирает прокси-сервер из списка.
4. Выбирает вариант маршрутизации.
5. Нажимает кнопку подключения.
6. Работает с системой.
7. Нажимает кнопку отключения.
8. Сворачивает приложение в трей или завершает его через меню трея.

---

## Границы проекта

Приложение:

* не реализует собственный VPN или прокси;
* не анализирует сетевой трафик;
* не вмешивается в работу сетевых протоколов;
* выполняет исключительно функции управляющей оболочки.
